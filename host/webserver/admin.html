<!DOCTYPE html>
<html>
<head>
  <title>holo host admin</title>
</head>
<body>
  <h1>holo host admin</h1>

  <h2>registered hApps:</h2>
  <ul id="registered-happs"></ul>

  <h2>hosted agents:</h2>
  <ul id="hosted-happs"></ul>

  <h2>service logs</h2>
  <div id="service-logs"></div>

  <script type="text/javascript">
    window.addEventListener('load', () => {
      addRegisteredApps()
      addHostedApps()
    })

    const displayApp = (hash, name) => `<pre>${hash} / ${name}</pre>`

    const addRegisteredApps = () => {
      const ul = document.querySelector('#registered-happs')
      fetch('/api/happs/registered').then(r => r.json()).then(happs => {
        const lis = happs.map(({name, hash}) => `
          <li>${ displayApp(hash, name) }</li>
        `)
        ul.innerHTML = lis.join('')
        addServiceLogs(happs)
      })
    }

    const addHostedApps = () => {
      const ul = document.querySelector('#hosted-happs')
      fetch('/api/happs/hosted').then(r => r.json()).then(happs => {
        const lis = happs.map(({appName, dnaHash, agentHash}) => `
            <li>${agentHash}: ${appName}</li>
        `)
        ul.innerHTML = lis.join('')
      })
    }

    const addServiceLogs = (happs) => {
      const div = document.querySelector('#service-logs')
      const promises = happs.map(happ => {
        return fetch(`/api/happs/${happ.hash}/service-logs`)
               .then(r => r.json())
      })
      Promise.all(promises).then(reports => {
        const items = reports.map((report, i) => {
          const happ = happs[i]
          const blocks = report.map(items => {
            const {agentHash, bundle} = items
            let rows = ''
            if (bundle.error) {
              rows = `
                <tr>
                  <td class="error" colspan="2">${bundle.error}</td>
                </tr>
              `
            } else {
              rows = bundle.map(serviceLog => `
                <tr>
                  <td><i>TODO</i></td>
                  <td>${ JSON.stringify(serviceLog.metrics) }</td>
                </tr>
              `)
            }
            return `
              <tr><th colspan="3">${ agentHash }</th></tr>
              ${ rows }
            `
          })
          return `
            <h3>${ happ.name }</h3>
            <table>
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Metrics</th>
                </tr>
              </thead>
              <tbody>
                ${ blocks }
              </tbody>
            </table>
          `
        })
        div.innerHTML = items.join('\n')
      })
    }
  </script>

  <style type="text/css">
    td, th {
      border-collapse: collapse;
      padding: 5px;
      margin: 0;
      border: 1px dotted black;
    }
    .error {
      background: #faa;
    }
  </style>
</body>
</html>